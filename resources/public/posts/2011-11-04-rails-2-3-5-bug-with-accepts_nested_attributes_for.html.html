<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Rubber Duck Dialogs: Rails 2.3.5 Bug With accepts_nested_attributes_for</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700' rel='stylesheet'
          type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/default.min.css">
    <link href="../css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/index.html">Rubber Duck Dialogs</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/index.html">Home</a></li>
                <li
                ><a href="/archives.html">Archives</a></li>
                
                <li><a href="/feed.xml">RSS</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">November 4, 2011</div>
        
    </div>
    <h2>Rails 2.3.5 Bug With accepts_nested_attributes_for</h2>
</div>
<div>
    
    <p>At work, our application has a series of questions it asks users, and an administrator can set a target of what he thinks (or wants) the answer to be.</p><pre><code class="ruby">class Question &lt; ActiveRecord::Base
  has&#95;many :targets
  accepts&#95;nested&#95;attributes&#95;for :targets, :allow&#95;destroy =&gt; true
end

class Target &lt; ActiveRecord::Base
  belongs&#95;to :question
end
</code></pre><p>The administrator fills the form out, choosing a target or not, and Rails will save, update, or destroy it as normal. Well, almost. <a href='https://github.com/rails/rails/commit/146a7505680cbb646c0b9d55dca7cc8494b36e47'>Apparently</a> there is a bug in Rails 2.3.5 that will save the child model twice, and we're experiencing that now.</p><h2><a name="what&#95;i&#95;want&#95;to&#95;do"></a>What I want to do</h2><p>Upgrade to Rails 3.1, get all the new hotness and bug fixes, and not worry about this problem.</p><h2><a name="what&#95;i'm&#95;going&#95;to&#95;do"></a>What I'm going to do</h2><p>Since we don't have the resources to upgrade Rails (yetâ€¦), we need a workaround. Here's what we came up with.</p><pre><code class="ruby">after&#95;save :ensure&#95;one&#95;target&#95;while&#95;in&#95;draft

def ensure&#95;one&#95;target&#95;while&#95;in&#95;draft
  if draft? &amp;&amp; targets.count &gt; 1
    targets&#91;1..-1&#93;.each { |t| t.destroy }
  end
end
</code></pre><p>This problem only comes up when a question has not been activated and is still in draft mode. Once it's activated, the administrator cannot change the target but only add additional ones. So while in that state, and if there are multiple targets, destroy all but the first. This needs to be in an <code>after&#95;save</code> callback because the double-save does not happen until after the question is saved. It's not elegant, but it works. I don't want to try to patch Rails and remember to deal with that later when we finally do upgrade, and the situation is isolated enough that there isn't a performance hit and it's easy to remove once it's no longer necessary. Elegant? No. But it's a bug fix for the framework, it's well documented in the code, and it works.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/ruby.html">ruby</a>
    
    <a href="/tags/bugs.html">bugs</a>
    
    <a href="/tags/rails.html">rails</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts/2011-11-18-welcome-the-new-guys.html.html">&laquo; Welcome the New Guys</a>
        
        
        <a class="right" href="/posts/2011-10-22-rails-security-refactor-protect-those-attributes.html.html">Rails Security Refactor - Protect Those Attributes &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                <h3>Links</h3>
                <ul id="links">
                    <li><a href="https://github.com/dbolson">GitHub</a></li>
                    <li><a href="https://www.linkedin.com/in/dodevelopment">LinkedIn</a></li>
                    
                </ul>
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/posts/2014-07-17-how-to-set-up-a-service-oriented-architecture-for-development.html.html">How to Set up a Service Oriented Architecture for Development</a></li>
                        
                        <li><a href="/posts/2014-03-22-what-do-you-get-when-you-send-an-engineer-to-poland-to-give-his-first-presentation.html.html">What Do You Get When You Send an Engineer to Poland to Give His First Presentation</a></li>
                        
                        <li><a href="/posts/2014-02-06-notes-on-markdown.html.html">Notes on Markdown</a></li>
                        
                    </ul>
                </div>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/tags/mysql.html">mysql</a></li>
                        
                        <li><a href="/tags/interviewing.html">interviewing</a></li>
                        
                        <li><a href="/tags/testing.html">testing</a></li>
                        
                        <li><a href="/tags/learning.html">learning</a></li>
                        
                        <li><a href="/tags/tools.html">tools</a></li>
                        
                        <li><a href="/tags/modularity.html">modularity</a></li>
                        
                        <li><a href="/tags/conferences.html">conferences</a></li>
                        
                        <li><a href="/tags/book review.html">book review</a></li>
                        
                        <li><a href="/tags/encoding.html">encoding</a></li>
                        
                        <li><a href="/tags/productivity.html">productivity</a></li>
                        
                        <li><a href="/tags/sass.html">sass</a></li>
                        
                        <li><a href="/tags/user interface.html">user interface</a></li>
                        
                        <li><a href="/tags/metaldetectr.html">metaldetectr</a></li>
                        
                        <li><a href="/tags/refactoring.html">refactoring</a></li>
                        
                        <li><a href="/tags/rspec.html">rspec</a></li>
                        
                        <li><a href="/tags/soa.html">soa</a></li>
                        
                        <li><a href="/tags/ruby.html">ruby</a></li>
                        
                        <li><a href="/tags/backbone.html">backbone</a></li>
                        
                        <li><a href="/tags/bugs.html">bugs</a></li>
                        
                        <li><a href="/tags/vim.html">vim</a></li>
                        
                        <li><a href="/tags/speaking.html">speaking</a></li>
                        
                        <li><a href="/tags/tests.html">tests</a></li>
                        
                        <li><a href="/tags/markdown.html">markdown</a></li>
                        
                        <li><a href="/tags/javascript.html">javascript</a></li>
                        
                        <li><a href="/tags/pair programming.html">pair programming</a></li>
                        
                        <li><a href="/tags/marionette.html">marionette</a></li>
                        
                        <li><a href="/tags/jquery.html">jquery</a></li>
                        
                        <li><a href="/tags/rails.html">rails</a></li>
                        
                        <li><a href="/tags/open source.html">open source</a></li>
                        
                        <li><a href="/tags/book reviews.html">book reviews</a></li>
                        
                        <li><a href="/tags/design patterns.html">design patterns</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2015 Danny Olson
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="../js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
